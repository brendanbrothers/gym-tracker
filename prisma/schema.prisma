generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// GYMS
// ============================================================================

model Gym {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users           User[]
  exercises       Exercise[]
  workoutSessions WorkoutSession[]

  @@index([slug])
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      Role     @default(CLIENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Gym association
  gym   Gym?    @relation(fields: [gymId], references: [id])
  gymId String?

  // A client's workout sessions
  workoutSessions WorkoutSession[] @relation("ClientSessions")

  // Sessions where this user was the trainer
  trainedSessions WorkoutSession[] @relation("TrainerSessions")

  // Exercises created by this user
  createdExercises Exercise[]

  @@index([email])
  @@index([role])
  @@index([gymId])
}

enum Role {
  CLIENT
  TRAINER
  GYM_ADMIN
  ADMIN
}

// ============================================================================
// EXERCISE LIBRARY
// ============================================================================

model Exercise {
  id            String         @id @default(cuid())
  name          String
  instructions  String?
  category      String?
  primaryMuscle String?
  equipment     String?
  images        String?
  source        ExerciseSource @default(CUSTOM)
  sourceId      String?
  isActive      Boolean        @default(true)
  isGlobal      Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  createdBy   User?   @relation(fields: [createdById], references: [id])
  createdById String?

  gym   Gym?    @relation(fields: [gymId], references: [id])
  gymId String?

  setExercises SetExercise[]

  @@unique([name, source, sourceId])
  @@index([name])
  @@index([category])
  @@index([primaryMuscle])
  @@index([gymId])
  @@index([isGlobal])
}

enum ExerciseSource {
  IMPORTED
  CUSTOM
}

// ============================================================================
// WORKOUT SESSIONS
// ============================================================================

model WorkoutSession {
  id        String        @id @default(cuid())
  date      DateTime
  notes     String?
  status    SessionStatus @default(IN_PROGRESS)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  client   User   @relation("ClientSessions", fields: [clientId], references: [id])
  clientId String

  trainer   User?   @relation("TrainerSessions", fields: [trainerId], references: [id])
  trainerId String?

  gym   Gym?    @relation(fields: [gymId], references: [id])
  gymId String?

  sets WorkoutSet[]

  @@index([clientId])
  @@index([trainerId])
  @@index([date])
  @@index([gymId])
}

enum SessionStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================================================
// WORKOUT SETS
// ============================================================================

model WorkoutSet {
  id        String   @id @default(cuid())
  order     Int
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workoutSession   WorkoutSession @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)
  workoutSessionId String

  exercises SetExercise[]

  @@index([workoutSessionId])
}

// ============================================================================
// SET EXERCISES
// ============================================================================

model SetExercise {
  id             String   @id @default(cuid())
  order          Int
  round          Int      @default(1)
  modifier       String?
  targetReps     Int?
  targetWeight   Float?
  targetDuration Int?
  actualReps     Int?
  actualWeight   Float?
  actualDuration Int?
  completed      Boolean  @default(false)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  exercise   Exercise @relation(fields: [exerciseId], references: [id])
  exerciseId String

  workoutSet   WorkoutSet @relation(fields: [workoutSetId], references: [id], onDelete: Cascade)
  workoutSetId String

  @@index([exerciseId])
  @@index([workoutSetId])
}